name: 'Setup Firebolt Core'
description: 'Sets up Firebolt Core Docker containers with certificates and waits for service readiness'
inputs:
  tag_version:
    description: 'The docker image tag for the firebolt core'
    required: false
    default: 'preview-rc'
outputs:
  docker_compose_file:
    description: 'Path to the Docker Compose file'
    value: ${{ steps.prepare-compose.outputs.docker_compose_file }}
  service_url:
    description: 'HTTP URL of the running service'
    value: ${{ steps.setup.outputs.service_url }}
  service_https_url:
    description: 'HTTPS URL of the running service'
    value: ${{ steps.setup.outputs.service_https_url }}

runs:
  using: 'composite'
  steps:
    - name: Checkout action repository
      uses: actions/checkout@v4
      with:
        repository: firebolt-db/action-setup-core
        path: action-setup-core

    - name: Setup Docker environment
      id: setup
      shell: bash
      env:
        SERVICE_URL: 'http://localhost:3473'
        SERVICE_HTTPS_URL: 'https://localhost:443'
        MAX_RETRIES: '30'
        RETRY_INTERVAL: '2'
      run: |
        # Detect the actual checkout location of the action
        ACTION_DIR="${{ github.workspace }}/action-setup-core"
        DOCKER_COMPOSE_FILE="$ACTION_DIR/resources/docker-compose.yml"
        echo "action_dir=$ACTION_DIR" >> $GITHUB_OUTPUT
        echo "docker_compose_file=$DOCKER_COMPOSE_FILE" >> $GITHUB_OUTPUT
        echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
        echo "service_https_url=$SERVICE_HTTPS_URL" >> $GITHUB_OUTPUT

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ github.token }}

    - name: Generate certificates
      shell: bash
      run: |
        mkdir -p "${{ steps.setup.outputs.action_dir }}/resources/certs"
        pip install trustme
        # Generate a self-signed certificate for localhost
        python3 -m trustme -d "${{ steps.setup.outputs.action_dir }}/resources/certs/"

    - name: Install certificates to keystore
      shell: bash
      run: |
        sudo cp "${{ steps.setup.outputs.action_dir }}/resources/certs/client.pem" /usr/local/share/ca-certificates/client.crt
        sudo update-ca-certificates
    
    - name: Install certificates to java keystore
      shell: bash
      run: |
        sudo keytool -importcert \
          -keystore "$JAVA_HOME/lib/security/cacerts" \
          -storepass changeit \
          -file "${{ steps.setup.outputs.action_dir }}/resources/certs/client.pem" \
          -alias dev-localhost \
          -noprompt

    - name: Set image tag
      id: set-tag
      shell: bash
      run: |
        IMAGE_TAG="${{ inputs.tag_version }}"
        echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Prepare docker-compose.yml
      id: prepare-compose
      shell: bash
      run: |
        ACTION_DIR="${{ steps.setup.outputs.action_dir }}"
        DOCKER_COMPOSE_FILE="${{ steps.setup.outputs.docker_compose_file }}"
        if [ ! -f "$DOCKER_COMPOSE_FILE" ]; then
          echo "Error: Docker compose file not found at $DOCKER_COMPOSE_FILE"
          exit 1
        fi
        
        # Replace variables in the original file
        sed -i "s|\${IMAGE_TAG}|${{ steps.set-tag.outputs.tag }}|g" "$DOCKER_COMPOSE_FILE"
        sed -i "s|\${BASE_DIR}|$ACTION_DIR|g" "$DOCKER_COMPOSE_FILE"
        
        # Output the prepared file path
        echo "docker_compose_file=$DOCKER_COMPOSE_FILE" >> $GITHUB_OUTPUT
        echo "Docker compose file prepared:"
        cat "$DOCKER_COMPOSE_FILE"

    - name: Start service containers
      shell: bash
      run: |
        DOCKER_COMPOSE_FILE="${{ steps.prepare-compose.outputs.docker_compose_file }}"
        docker compose -f "$DOCKER_COMPOSE_FILE" up -d
        docker compose -f "$DOCKER_COMPOSE_FILE" ps

    - name: Wait for service to be ready
      shell: bash
      env:
        SERVICE_URL: 'http://localhost:3473'
        MAX_RETRIES: '30'
        RETRY_INTERVAL: '2'
      run: |
        for i in $(seq 1 $MAX_RETRIES); do
          if curl --silent --fail "$SERVICE_URL" --data-binary "SELECT 1" | grep -q "1"; then
            echo "Service is up and responding!"
            exit 0
          fi
          echo "Waiting for service... ($i/$MAX_RETRIES)"
          sleep $RETRY_INTERVAL
        done
        echo "Error: Service failed to start within timeout"
        docker compose -f "${{ steps.prepare-compose.outputs.docker_compose_file }}" logs
        exit 1

    - name: Spin down containers
      if: always()
      uses: gacts/run-and-post-run@v1
      with:
        post: docker compose -f "${{ steps.prepare-compose.outputs.docker_compose_file }}" down